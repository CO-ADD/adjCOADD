<!-- Step line container -->
<h1 class="text-center">{{data_model}} Data Import</h1>
<div class="row m-5 w-80 h-100 border">
  <form
    method="post"
    enctype="multipart/form-data"
    class="col-md-8 mx-5 d-flex flex-column align-items-center w-75 h-75 text-center"
  >
    <!--prettier-ignore-->
    {% csrf_token %}
        {{ wizard.management_form }}

    <div class="row h-75 gx-5 mt-3" style="width: 100%">
      <!-- Left column -->
      <div class="col-md-5 border-end" style="position: relative">
        <h5 class="bg-light" style="position: absolute; left: 0; top: -25px">
          Processing TimeLine:
        </h5>

        <div class="d-flex justify-content-around mt-5">
          <div class="step-line h-25 mx-2">
            <div
              class="step {% if wizard.steps.current == 'upload_file' %}active{% endif %}"
            >
              Upload File
            </div>
            <div
              class="step {% if wizard.steps.current == 'step1' %}active{% endif %}"
            >
              {{step1}}
            </div>

            <!-- add more steps here for example:    <div class="step {% if wizard.steps.current == 'step2' %}active{% endif %}">{{step2}}</div> -->

            <div
              class="step {% if wizard.steps.current == 'finalize' %}active{% endif %}"
            >
              Finalize
            </div>
          </div>
          {% if wizard.steps.current == 'upload_file' %}
          <div>
            {% for field in wizard.form %}
            <p class="m-5">
              {{ field.label_tag }} {{ field }}
              <span class="badge bg-info text-light"
                >{{ field.help_text }}</span
              >
            </p>
            {% endfor %}
          </div>
          <!-- This is step 1-->
          {% elif wizard.steps.current == 'step1' %}
          <!-- Check to next step, if upload files contain errors(Confirm_to_Save=False) -->
          {%if Confirm_to_Save%}
          <div>
            {% for field in wizard.form %}
            <p class="m-5">
              {{ field.label_tag }} {{ field }}
              <span class="badge bg-info text-light"
                >{{ field.help_text }}</span
              >
            </p>
            {% endfor %}
          </div>
          {%else%}
          <div>
            <p class="m-5">
              <div>
                {% for field in wizard.form %}
                <p class="m-5">
                  {{ field.label_tag }} {{ field }}
                  <span class="badge bg-info text-light"
                    >{{ field.help_text }}</span
                  >
                </p>
                {% endfor %}
              </div>
              <span class="badge bg-info text-light">
                Upload files contain errors, please follow the info in right
                column to correct them.
              </span>
            </p>
          </div>
          {%endif%}
          <!-- add more steps here: ...-->

          <!-- This is the final-->
          {% elif wizard.steps.current == 'finalize' %}
          <div>
            {% for field in wizard.form %}
            <p class="m-5">
              {{ field.label_tag }} {{ field }}
              <span class="badge bg-info text-light"
                >{{ field.help_text }}</span
              >
            </p>

            <!--prettier-ignore-->
            {% endfor %}
          </div>
          {% endif %}
        </div>
        <div class="row m-2 p-0 mt-5 px-4" style="width: 90%">
          <div class="row gx-5">
            {% if wizard.steps.prev %}
            <a
              type="button"
              class="btn btn-sm col-md-3"
              href="{%url 'import-vitek'%}"
              onclick="window.location.reload(true);"
              >Cancel
            </a>
            <button
              class="btn btn-sm col-md-3"
              name="wizard_goto_step"
              type="submit"
              value="{{ wizard.steps.prev }}"
            >
              previous
            </button>
            {%else%}
            <button type="button" class="btn btn-sm col-md-3" disabled>
              cancel
            </button>
            <button
              class="btn btn-sm col-md-3"
              name="wizard_goto_step"
              disabled
            >
              previous
            </button>
            <!--prettier-ignore-->
            {% endif %} 
            {%if wizard.steps.next%}
            <input class="btn btn-sm col-md-3" type="submit" value="Next" />
            {%else%}
            <input class="btn btn-sm col-md-3" type="submit" value="Finalize" />
            {%endif%}
          </div>
          <p class="badge ms-0 text-start text-info">
            Click button move to next step, <br />Click previous to
            <strong class="text-danger"> upload file </strong>will need a
            re-upload. <br />Click cancel to refresh page and start again.
          </p>
        </div>
      </div>
      <!-- Right column with fixed position and size -->
      <div class="col-md-5" style="position: relative">
        <h5 class="bg-light" style="position: absolute; left: 5%; top: -25px">
          Processing Messages:
        </h5>
        <div class="progress" style="height: 20px">
    
          <span
            id="progress-bar"
            class="progress-bar"
            role="progressbar"
            style="width: 0%"
            aria-valuenow="0"
            aria-valuemin="0"
            aria-valuemax="100"
          >
            0%
          </span>
        </div>
        <div class="mt-5">
          <ul class="text-start" id="multi-files-list"></ul>
          <p class="progressfilename text-info"></p>
          <!--prettier-ignore-->
          {% for field in wizard.form %}
          {% for error in field.errors %}
          <p class="text-danger show-error">{{ error }}</p>
          {% endfor %}
          <!--prettier-ignore-->
          {% endfor %}
          <button class="btn btn-sm" id="fetchResults" type="button">fetch result</button>
          <div class="validation_result"></div>
        </div>
      </div>
    </div>
  </form>

 
</div>

<script>
  const $fileNamesContainer_files = $("#multi-files-list");

  if ("{{ form.multi_files.auto_id }}") {
    $("#{{ form.multi_files.auto_id }}").on("change", function () {
      $fileNamesContainer_files.empty();
      const files = this.files;
      for (let i = 0; i < files.length; i++) {
        let select_li=files[i].name
        
        const fileInfo = $("<li data-name='"+select_li+"'></li>").text(
          files[i].webkitRelativePath || files[i].name
        );
        $fileNamesContainer_files.append(fileInfo);
      }
    });
    $("#id_upload_file-multi_files").click(() => {
      $(".show-error").text("");
    });
  }
</script>
<script>
  $(document).ready(function () {
    if($('input:checkbox')){
      $('input:checkbox').attr("disabled", true);
    }
    function updateProgress() {
      console.log("call function");
      $.ajax({
        url: "{% url 'get_upload_progress' %}",
        type: "GET",
        success: function (data) {
          let processed = data.processed;
          console.log("Progress data fetched:", data);
          let total = data.total;
          let file_name=data.file_name
          let percentage =
            total > 0 ? Math.round((processed / total) * 100) : 0;
          $("#multi-files-list li").each(()=>{
            console.log($(this).data("name"))
            if ($(this).data("name").toString() === file_name.toString()) {
           $(this).addClass("text-danger");
}
          })
          if($("#progress-bar").hasClass("not-visible")){
        $("#progress-bar").removeClass("not-visible")
      }
          $("#progress-bar")
            .css("width", percentage + "%")
            .attr("aria-valuenow", percentage)
            .text(
              percentage +
                "%" +
                " (" +
                processed +
                " in " +
                total +
                "total files)"
            );
          // if (file_name){

            $(".progressfilename").html(`<span>${file_name}</span>`);
          // }

          if (processed==0 || processed < total) {
            console.log("called ...");
            setTimeout(updateProgress, 200);
            // setInterval(updateProgress, 1000);
          }
       
        },
      });
    }

    // Start updating progress when the page loads
    updateProgress();
    $('input[value="Next"]').click(()=>{
     
      updateProgress() 
  
  })
  $('input[value="Finalize"], input[value="Cancel"]').click(()=>{
      console.log('empty progress-bar')
      $("#progress-bar").empty()
                        .addClass("not-visible");
      $(".progressfilename").empty();
  
  })

// This function sends a GET request to the server every 2 seconds to check if the results are ready.
function fetchResults() {
  $.ajax({
        url: "{% url 'fetch-results' %}",  // Set this to the appropriate URL in your Django app.
        success: function(data) {
            let result_table=data.validation_result.valLog
            if (data.results_ready) {
              $('#fetchResults').addClass('text-success')
              $('input:checkbox').attr("disabled", false);
              // If the results are ready, update the page.
              $('.validation_result').html(result_table);
              
              // You could also stop the polling here, if you want.
            } else {
              // If the results are not ready, try again in 2 seconds.
              setTimeout(fetchResults, 500);
            }
          }
        });
      }
      $('#fetchResults').click(()=>{
        console.log("result...")
        fetchResults();

      })
    });
</script>
