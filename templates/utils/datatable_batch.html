<table id="datatable_batch" class="cell-border" style="width: 100%">
  <thead>
    <tr>
      <th>

      </th>
      <!-- <th style="width: 10em">EDIT</th> -->
      <th class="not-visible">Batch ID</th>
      {%for th in batch_fields %}
      <th>{{th}}</th>
      {%endfor%}
    </tr>
  </thead>
  <tbody hx-target="closest tr" hx-swap="outerHTML">
    {% for object_batch in batch_obj %}
    <!--  -->
    {%include 'dorganism/organism/batch/batch_tr.html'%}
    <!--  -->
    {%endfor%}
  </tbody>
</table>
<script src="https://unpkg.com/htmx.org@1.8.4"
  integrity="sha384-wg5Y/JwF7VxGk4zLsJEcAojRtlVp1FKKdGy1qN+OMtdq72WRvX/EdRdqg/LOhYeV" crossorigin="anonymous"></script>

{%load static%}
<script type="text/javascript" src="{% static 'js/create_modal.js' %}"></script>
<script type="text/javascript" src="{% static 'js/editablerow_stock.js' %}"></script>

<script>
  // Define permission
  const user_permission = '{{user.permission}}'
  var defaultContent = (data, type, row) => {
    console.log(user_permission)
    return user_permission == 'Admin' ?
      (`<button id="update_stock" class="text-success border-0"> <i class="fa-regular fa-pen-to-square"></i></button>` +
        '<div id="updateStockModal" class="modal fade" role="dialog"></div>' +
        "&nbsp; " +
        `<button id="delete_stock" class="border-0"> <i class="fa-regular fa-trash-can"></i></button>` +
        '<div id="deleteStockModal" class="modal " role="dialog"></div>')
      :
      (`<button class="text-secondary border-0" disabled> <i class="fa-regular fa-pen-to-square"></i></button>` +
        '<div id="updateStockModal" class="modal fade" role="dialog"></div>' +
        "&nbsp; " +
        `<button class="border-0" disabled> <i class="fa-regular fa-trash-can"></i></button>` +
        '<div id="deleteStockModal" class="modal " role="dialog"></div>')

  }


  $(document).ready(function () {
    // Table Batch
    var table = $("#datatable_batch").DataTable({
      searching: false,
      paging: false,
      info: false
    });

    const csrftoken = getCookie("csrftoken");
    $("#datatable_batch tbody").on("click", "a.dt-control", function (e) {
      var tr = $(this).closest("tr");
      var row = table.row(tr);

      if (row.child.isShown()) {
        // This row is already open - close it
        destroyChild(row);
        tr.removeClass("shown");
      } else {
        // Open this row
        // getStockData(row.data()[1]);
        createChild(row);
        tr.addClass("shown");
      }
    });
  });
  function createChild(row) {
    // This is the table we'll convert into a DataTable
    var Batch_id = row.data()[1];
    var table = $('<table id="Stock" class="display" width="100%"/>');

    // Display it the child row
    row.child(table).show();

    // Initialise as a DataTable
    var usersTable = table.DataTable({
      dom: "Bfrtip",
      pageLength: 1,
      ajax: {
        url: `/stocklist/${Batch_id}`,
        type: "GET",
        headers: { "X-CSRFToken": csrftoken },
        data: { Batch_id },
      },

      columns: [
        // { title: "Stock ID", data: "stock_id" },
        {
          "title": `<a class="card-link" id="create_stock" style="z-index:10"><i class="bi bi-file-earmark-plus text-success"></i></a>
        <div id="createStockModal" class="modal fade" role="dialog"></div> New `,
          "data": null,
          "defaultContent": defaultContent()
        },
        { title: "Type", data: "stock_type" },
        { title: "Freezer", data: "location_freezer" },
        { title: "Rack", data: "location_rack" },
        { title: "Col", data: "location_col" },
        { title: "Slot", data: "location_slot" },

        { title: "Stock Date", data: "stock_date", type: "datetime" },
        {
          title: "Left",
          data: "n_left",
          className: "editablerow_stock n_left_column",

        },
        { title: "Created", data: "n_created" },
        { title: "Note", data: "stock_notes" },
        { title: "Biologist", data: "biologist" },
      ],
      columnDefs: [
        {
          targets: [7],
          createdCell: function (cell, cellData, rowData, rowIndex, colIndex) {
            if (colIndex === 7) {
              var dataValue = rowData.stock_id;
              $(cell).attr('data-name', dataValue);
              $(cell).attr('data-type', 'n_left');
            }
          }
        }
      ],
      // select: true,
      searching: false,
      paging: false,
      info: false
    });
    loadOrganismModal("#createStockModal", "#create_stock", "/createStock/");
    $("#Stock tbody").on("click", `#delete_stock`, function () {
      var data = usersTable.row($(this).parents("tr")).data();
      let my_modal = $("#deleteStockModal");
      console.log(data);
      var pk = data["stock_id"].toString();
      console.log(pk);
      my_modal.load(`deleteStock/${pk}`, function (response) {
        if (response == "Permission Not Granted") {
          alert("permission!");
        } else {
          my_modal.modal("show"); // Open Modal
        }
      });
    });

    $("#Stock tbody").on("click", `#update_stock`, function () {
      var data = usersTable.row($(this).parents("tr")).data();
      let my_modal = $("#updateStockModal");
      console.log(data);
      var pk = data["stock_id"].toString();
      console.log(pk);
      my_modal.load(`updateStock/${pk}`, function (response) {
        if (response == "Permission Not Granted") {
          alert("permission!");
        } else {
          my_modal.modal("show"); // Open Modal
        }
      });
    });
  }
  function destroyChild(row) {
    var table = $("table", row.child());
    table.detach();
    table.DataTable().destroy();

    // And then hide the row
    row.child.hide();
  }

  const csrftoken = getCookie("csrftoken");
</script>